{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}Review Submission{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-10 px-4 md:px-8">
  <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Left Section -->
    <div class="lg:col-span-2 space-y-8">
      <!-- Submission Details -->
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
            <i class="fas fa-file-alt text-blue-600"></i> Review Submission
          </h2>
          <span class="text-xs text-gray-500">Submitted {{ submission.submitted_at|date:"M d, Y H:i" }}</span>
        </div>

        <div class="text-gray-700 space-y-1 mb-4">
          <p>Task: <strong class="text-blue-700">{{ submission.task.title }}</strong></p>
          <p>Member: <strong>{{ submission.member.username }}</strong></p>
        </div>

        {% if submission.proof_text %}
        <div class="mt-6">
          <h3 class="text-lg font-semibold text-gray-700 mb-2">Proof Description</h3>
          <div class="border border-gray-200 rounded-xl bg-gray-50 p-4 leading-relaxed text-gray-700">
            {{ submission.proof_text|linebreaks }}
          </div>
        </div>
        {% endif %}

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
          {% if submission.proof_file %}
          <div class="bg-blue-50 rounded-xl p-4 border border-blue-100">
            <h4 class="font-semibold text-gray-800 mb-2">Uploaded File</h4>
            <a href="{{ submission.proof_file.url }}" target="_blank"
               class="inline-flex items-center text-blue-700 font-medium hover:text-blue-900 transition">
              <i class="fas fa-file mr-2"></i> View File
            </a>
          </div>
          {% endif %}

          {% if submission.screenshot %}
          <div class="bg-gray-50 border border-gray-200 rounded-xl p-4">
            <h4 class="font-semibold text-gray-800 mb-2">Screenshot</h4>
            <div class="overflow-hidden rounded-lg shadow-sm border border-gray-100">
              <img src="{{ submission.screenshot.url }}" class="rounded-md max-h-48 w-full object-contain">
            </div>
            <a href="{{ submission.screenshot.url }}" target="_blank"
               class="inline-flex items-center text-blue-700 mt-3 text-sm hover:text-blue-900 transition">
              <i class="fas fa-expand mr-2"></i> View Full Size
            </a>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- Task Requirements -->
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition p-6">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
          <i class="fas fa-tasks text-purple-600"></i> Task Requirements
        </h3>
        <div class="text-gray-700 space-y-2">
          <p><strong>Description:</strong> {{ submission.task.description }}</p>
          <p><strong>Proof Instructions:</strong> {{ submission.task.proof_instructions }}</p>
          <p><strong>Payout:</strong>
            <span class="text-green-700 font-semibold">â‚¦{{ submission.task.payout_per_slot }}</span>
          </p>
        </div>
      </div>

      <!-- Chat Section -->
      <div class="bg-green-50 border border-green-200 rounded-xl p-5">
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0">
            <i class="fas fa-comments text-green-700 text-lg"></i>
          </div>
          <div>
            <h3 class="font-semibold text-green-800 mb-1">Chat with Worker</h3>
            <p class="text-green-700 text-sm">
              View chat conversation:
             {% if room %}
              <a href="{% url 'chat:room' room.id %}" class="underline hover:text-green-900">Open Chat</a>
            {% else %}
              <span class="text-gray-500 text-sm">No chat room yet</span>
            {% endif %}

            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Section: Review Decision -->
    <div>
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 hover:shadow-md transition p-6 sticky top-24">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
          <i class="fas fa-clipboard-check text-blue-600"></i> Review Decision
        </h3>

        <form method="post" class="space-y-6" data-validate>
          {% csrf_token %}
          <!-- Decision -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-3">Decision</label>
            <div class="space-y-2">
              {% for choice in form.decision %}
              <label
                class="flex items-center gap-2 cursor-pointer px-3 py-2 border rounded-lg hover:bg-gray-50 transition">
                {{ choice.tag }}
                <span class="text-gray-800">{{ choice.choice_label }}</span>
              </label>
              {% endfor %}
            </div>
          </div>

          <!-- Rejection Reason -->
          <div id="rejection-reason-block">
            <label for="{{ form.rejection_reason.id_for_label }}"
                   class="block text-sm font-medium text-gray-700 mb-2">
              Rejection Reason <span class="text-gray-400">(if rejecting)</span>
            </label>
            {{ form.rejection_reason|add_class:"form-input w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring focus:ring-blue-200" }}
          </div>

          <div class="flex flex-col gap-3">
            <button type="submit"
                    class="btn-primary bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 rounded-lg transition">
              Submit Review
            </button>
            <a href="{% url 'tasks:review_submissions' submission.task.id %}"
               class="btn-secondary text-center border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg py-2.5 transition">
              Back to Reviews
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const decisionInputs = document.querySelectorAll('input[name="decision"]');
  const rejectionReasonBlock = document.querySelector('#rejection-reason-block');

  function toggleRejectionReason() {
    const selected = document.querySelector('input[name="decision"]:checked');
    rejectionReasonBlock.style.display = (selected && selected.value === 'reject') ? 'block' : 'none';
  }

  decisionInputs.forEach(input => input.addEventListener('change', toggleRejectionReason));
  toggleRejectionReason(); // Initial state
});
</script>
{% endblock %}
