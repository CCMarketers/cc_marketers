{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}Review Submission{% endblock %}

{% block content %}

<div class="grid grid-cols-1 md:grid-cols-3 gap-8">
  <!-- Left: Submission & Task -->
  <div class="md:col-span-2 space-y-6">
    <!-- Submission Details -->
    <div class="bg-white rounded-xl shadow card-hover p-6 fade-in-up">
      <h2 class="text-xl font-bold text-gray-800 mb-2">Review Submission</h2>
      <p class="text-gray-600">Task: <strong>{{ submission.task.title }}</strong></p>
      <p class="text-gray-600">Member: <strong>{{ submission.member.username }}</strong></p>
      <p class="text-sm text-gray-500">Submitted {{ submission.submitted_at|date:"M d, Y H:i" }}</p>

      <div class="mt-6 space-y-6">
        {% if submission.proof_text %}
        <div>
          <h3 class="text-lg font-semibold text-gray-700 mb-2">Proof Description</h3>
          <div class="border rounded-lg bg-gray-50 p-4 text-gray-700">
            {{ submission.proof_text|linebreaks }}
          </div>
        </div>
        {% endif %}

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          {% if submission.proof_file %}
          <div>
            <h4 class="font-semibold text-gray-700 mb-2">Uploaded File</h4>
            <a href="{{ submission.proof_file.url }}" target="_blank" class="btn-secondary inline-flex items-center">
              <i class="fas fa-file mr-2"></i> View File
            </a>
          </div>
          {% endif %}

          {% if submission.screenshot %}
          <div>
            <h4 class="font-semibold text-gray-700 mb-2">Screenshot</h4>
            <img src="{{ submission.screenshot.url }}" class="rounded-lg shadow max-h-48 object-contain border">
            <a href="{{ submission.screenshot.url }}" target="_blank" class="btn-secondary btn-sm mt-3 inline-flex items-center">
              <i class="fas fa-expand mr-2"></i> View Full Size
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Task Requirements -->
    <div class="bg-white rounded-xl shadow card-hover p-6 fade-in-up">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">Task Requirements</h3>
      <p class="mb-2"><strong>Description:</strong> <span class="text-gray-700">{{ submission.task.description }}</span></p>
      <p class="mb-2"><strong>Proof Instructions:</strong> <span class="text-gray-700">{{ submission.task.proof_instructions }}</span></p>
      <p><strong>Payout:</strong> <span class="text-green-700 font-semibold">₦{{ submission.task.payout_per_slot }}</span></p>
    </div>
  </div>

<!-- ✅ For advertiser viewing submissions -->
    <div class="bg-green-50 border border-green-200 rounded-lg p-4 mt-4">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="font-semibold text-green-800 mb-1">
                    <i class="fas fa-comments mr-2"></i>
                    Chat with Workers
                </h3>
                <p class="text-green-700 text-sm">
                    View all conversations: 
                    <a href="{% url 'chat:room_list' %}" class="underline">My Chats</a>
                </p>
            </div>
        </div>
    </div>
  <!-- Right: Decision Form -->
  <div>
    <div class="bg-white rounded-xl shadow card-hover p-6 fade-in-up">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">Review Decision</h3>

      <form method="post" class="space-y-4" data-validate>
        {% csrf_token %}

        <!-- Decision -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Decision</label>
          <div class="space-y-2">
            {% for choice in form.decision %}
            <label class="flex items-center space-x-2 cursor-pointer">
              {{ choice.tag }}
              <span class="text-gray-700">{{ choice.choice_label }}</span>
            </label>
            {% endfor %}
          </div>
        </div>

        <!-- Rejection Reason -->
        <div id="rejection-reason-block">
          <label for="{{ form.rejection_reason.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
            Rejection Reason <span class="text-gray-400">(if rejecting)</span>
          </label>
          {{ form.rejection_reason|add_class:"form-input" }}
        </div>

        <div class="flex flex-col gap-3">
          <button type="submit" class="btn-primary">Submit Review</button>
          <a href="{% url 'tasks:review_submissions' submission.task.id %}" class="btn-secondary text-center">Back to Reviews</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const decisionInputs = document.querySelectorAll('input[name="decision"]');
  const rejectionReasonBlock = document.querySelector('#rejection-reason-block');

  function toggleRejectionReason() {
    const selected = document.querySelector('input[name="decision"]:checked');
    if (selected && selected.value === 'reject') {
      rejectionReasonBlock.style.display = 'block';
    } else {
      rejectionReasonBlock.style.display = 'none';
    }
  }

  decisionInputs.forEach(input => {
    input.addEventListener('change', toggleRejectionReason);
  });

  toggleRejectionReason(); // Initial state
});
</script>
{% endblock %}
