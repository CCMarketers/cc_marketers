<!-- payments/templates/payments/withdraw.html -->
{% extends 'base.html' %}

{% block title %}Withdraw Funds{% endblock %}

{% block content %}
<div class="min-h-screen py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-2xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold text-red-600">Withdraw Funds</h2>
            <p class="mt-2 text-gray-600">Transfer money from your wallet to your bank account</p>
        </div>

        <!-- Messages -->
        {% if messages %}
            <div class="mb-6">
                {% for message in messages %}
                    <div class="p-4 rounded-lg {% if message.tags == 'error' %}bg-red-50 text-red-700 border border-red-200{% elif message.tags == 'success' %}bg-green-50 text-green-700 border border-green-200{% else %}bg-blue-50 text-blue-700 border border-blue-200{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Form -->
        <div class="bg-white border-2 border-red-100 rounded-lg shadow-lg p-6">
            <form method="post" id="withdrawal-form">
                {% csrf_token %}

                <!-- Amount -->
                <div class="mb-6">
                    <label for="{{ form.amount.id_for_label }}" class="block text-sm font-semibold text-red-600 mb-2">
                        Amount ($)
                    </label>
                    {{ form.amount }}
                    {% if form.amount.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {{ form.amount.errors.0 }}
                        </div>
                    {% endif %}
                </div>

                <!-- Gateway Choice -->
                {% if show_gateway_choice %}
                <div class="mb-6">
                    <label for="{{ form.gateway.id_for_label }}" class="block text-sm font-semibold text-red-600 mb-2">
                        Payment Gateway
                    </label>
                    {{ form.gateway }}
                    {% if form.gateway.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {{ form.gateway.errors.0 }}
                        </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Bank -->
                <div class="mb-6">
                    <label for="bank_select" class="block text-sm font-semibold text-red-600 mb-2">
                        Select Bank
                    </label>
                    <select id="bank_select" name="bank_code" class="w-full px-4 py-3 border border-red-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent" required>
                        <option value="">Loading banks...</option>
                    </select>
                    {% if form.bank_code.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {{ form.bank_code.errors.0 }}
                        </div>
                    {% endif %}
                </div>

                <!-- Account Number -->
                <div class="mb-6">
                    <label for="account_number" class="block text-sm font-semibold text-red-600 mb-2">
                        Account Number
                    </label>
                    {{ form.account_number }}
                    {% if form.account_number.errors %}
                        <div class="mt-1 text-sm text-red-600">
                            {{ form.account_number.errors.0 }}
                        </div>
                    {% endif %}
                </div>

                <!-- Account Name -->
                <div class="mb-6 hidden" id="account-name-section">
                    <label class="block text-sm font-semibold text-red-600 mb-2">Account Name</label>
                    <div id="account-name-display" class="w-full px-4 py-3 bg-red-50 border border-red-200 rounded-lg text-gray-700">
                        <!-- account name appears here -->
                    </div>
                </div>

                <!-- Notices -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h3 class="text-sm font-medium text-blue-800">Withdrawal Information</h3>
                    <p class="mt-2 text-sm text-blue-700">
                        Minimum withdrawal: $1. Processing time: 5–15 minutes.
                    </p>
                </div>

                <!-- Submit -->
                <button type="submit" id="submit-btn" class="w-full bg-gray-400 text-white py-3 px-4 rounded-lg font-semibold cursor-not-allowed" disabled>
                    <span id="submit-text">Verify Account Details</span>
                    <span id="loading-spinner" class="hidden">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Processing...
                    </span>
                </button>
            </form>
        </div>

        <!-- Back -->
        <div class="text-center mt-6">
            <a href="{% url 'wallets:dashboard' %}" class="text-red-600 hover:text-red-800 font-medium">
                ← Back to Wallet
            </a>
        </div>
    </div>
</div>

<script>
    let banks = [];
    let isAccountVerified = false;

    document.addEventListener('DOMContentLoaded', function() {
        loadBanks();
        setupEvents();
    });

    function getGateway() {
        const gatewaySelect = document.querySelector('select[name="gateway"]');
        return gatewaySelect ? gatewaySelect.value : 'paystack';
    }

    function loadBanks() {
        const banksUrl = getGateway() === 'flutterwave'
            ? '{% url "payments:get_flutterwave_banks" %}'
            : '{% url "payments:get_banks" %}';

        fetch(banksUrl)
            .then(r => r.json())
            .then(data => {
                const bankSelect = document.getElementById('bank_select');
                bankSelect.innerHTML = '<option value="">Select Bank</option>';
                if (data.success && data.banks) {
                    data.banks.forEach(bank => {
                        const option = document.createElement('option');
                        option.value = bank.code;
                        option.textContent = bank.name;
                        bankSelect.appendChild(option);
                    });
                }
            })
            .catch(err => {
                console.error('Error loading banks:', err);
                document.getElementById('bank_select').innerHTML = '<option>Error loading banks</option>';
            });
    }

    function setupEvents() {
        const gatewaySelect = document.querySelector('select[name="gateway"]');
        const bankSelect = document.getElementById('bank_select');
        const accountNumberInput = document.getElementById('account_number');

        if (gatewaySelect) gatewaySelect.addEventListener('change', loadBanks);
        bankSelect.addEventListener('change', debounce(checkVerify, 500));
        accountNumberInput.addEventListener('input', debounce(checkVerify, 500));
    }

    function checkVerify() {
        const bankCode = document.getElementById('bank_select').value;
        const accountNumber = document.getElementById('account_number').value;
        if (bankCode && accountNumber.length === 10) {
            verifyAccount(bankCode, accountNumber);
        } else {
            hideAccount();
            updateSubmit(false);
        }
    }

    function verifyAccount(bankCode, accountNumber) {
        const section = document.getElementById('account-name-section');
        const display = document.getElementById('account-name-display');
        section.classList.remove('hidden');
        display.innerHTML = 'Verifying...';

        const verifyUrl = getGateway() === 'flutterwave'
            ? '{% url "payments:verify_flutterwave_account" %}'
            : '{% url "payments:verify_account" %}';

        fetch(verifyUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ bank_code: bankCode, account_number: accountNumber })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                display.innerHTML = data.account_name;
                isAccountVerified = true;
                updateSubmit(true);
            } else {
                display.innerHTML = `<span class="text-red-600">Error: ${data.error}</span>`;
                isAccountVerified = false;
                updateSubmit(false);
            }
        })
        .catch(err => {
            console.error('Error verifying account:', err);
            display.innerHTML = '<span class="text-red-600">Verification failed</span>';
            isAccountVerified = false;
            updateSubmit(false);
        });
    }

    function hideAccount() {
        document.getElementById('account-name-section').classList.add('hidden');
        isAccountVerified = false;
    }

    function updateSubmit(canSubmit) {
        const btn = document.getElementById('submit-btn');
        const text = document.getElementById('submit-text');
        if (canSubmit && isAccountVerified) {
            btn.disabled = false;
            btn.className = 'w-full bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-lg font-semibold transition duration-200';
            text.textContent = 'Process Withdrawal';
        } else {
            btn.disabled = true;
            btn.className = 'w-full bg-gray-400 text-white py-3 px-4 rounded-lg font-semibold cursor-not-allowed';
            text.textContent = 'Verify Account Details';
        }
    }

    // debounce
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }
</script>
{% endblock %}
